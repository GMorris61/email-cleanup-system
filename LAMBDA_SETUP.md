# AWS Lambda Deployment Guide

This guide walks through deploying the Email Cleanup System to AWS Lambda with EventBridge scheduling.

## Prerequisites

- AWS Account with access to Lambda, EventBridge, and Secrets Manager
- IAM permissions to create functions and manage secrets
- Gmail API credentials (from local setup)
- Refresh token (generated by running local script)

## Step 1: Extract Refresh Token

Run the local script to generate a `token.pickle` file:

```bash
python3 email_cleanup.py --dry-run
```

Once authenticated, extract the refresh token:

```bash
python3 -c "
import pickle
with open('token.pickle', 'rb') as f:
    creds = pickle.load(f)
    print(f'Refresh Token: {creds.refresh_token}')
"
```

Save this token — you'll need it in Step 2.

## Step 2: Store Credentials in AWS Secrets Manager

1. Go to [AWS Secrets Manager Console](https://console.aws.amazon.com/secretsmanager)
2. Click **"Store a new secret"**
3. Choose **"Other type of secret"**
4. Paste this JSON (fill in your credentials):

```json
{
  "type": "authorized_user",
  "client_id": "YOUR_CLIENT_ID_HERE.apps.googleusercontent.com",
  "client_secret": "YOUR_CLIENT_SECRET_HERE",
  "refresh_token": "YOUR_REFRESH_TOKEN_HERE"
}
```

5. Name it: `gmail-credentials`
6. Click **"Store secret"**

**Where to find these values:**
- `client_id` and `client_secret`: In your downloaded `credentials.json`
- `refresh_token`: From Step 1 above

## Step 3: Create IAM Role for Lambda

1. Go to [IAM Console](https://console.aws.amazon.com/iam)
2. Click **"Roles"** → **"Create role"**
3. Choose **"AWS Lambda"** as the trusted entity
4. Click **"Next"**
5. Add these permissions:
   - `AWSLambdaBasicExecutionRole` (for CloudWatch logs)
   - Create inline policy for Secrets Manager:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": "arn:aws:secretsmanager:*:*:secret:gmail-credentials*"
    }
  ]
}
```

6. Name the role: `email-cleanup-lambda-role`
7. Click **"Create role"**

## Step 4: Package Lambda Code

```bash
# Create deployment package
mkdir lambda-deployment
cd lambda-deployment

# Copy files
cp ../email_cleanup.py .
cp ../lambda_handler.py .
cp ../config.py .
cp ../requirements.txt .

# Install dependencies
pip install -r requirements.txt -t .

# Remove unnecessary files
rm -rf requirements.txt *.dist-info __pycache__

# Create ZIP
zip -r lambda-deployment.zip .
cd ..
```

## Step 5: Create Lambda Function

1. Go to [Lambda Console](https://console.aws.amazon.com/lambda)
2. Click **"Create function"**
3. Choose:
   - **Function name**: `email-cleanup-system`
   - **Runtime**: Python 3.11
   - **Architecture**: x86_64
4. Under **Change default execution role**, select:
   - **Existing role**: `email-cleanup-lambda-role`
5. Click **"Create function"**

## Step 6: Upload Code

1. In the Lambda console, scroll to **"Code source"**
2. Click **"Upload from"** → **".zip file"**
3. Upload the `lambda-deployment.zip` from Step 4
4. Click **"Save"**

## Step 7: Configure Function Settings

1. Click **"Configuration"** tab
2. Go to **"General configuration"**
3. Click **"Edit"** and set:
   - **Timeout**: 60 seconds
   - **Memory**: 256 MB
4. Click **"Save"**

## Step 8: Create EventBridge Trigger

1. Go to [EventBridge Console](https://console.aws.amazon.com/events)
2. Click **"Create rule"**
3. Set:
   - **Name**: `email-cleanup-daily`
   - **Description**: `Daily email cleanup at 9 AM`
   - **Schedule pattern**: `cron(0 9 * * ? *)`
   - **Timezone**: Your timezone
4. Click **"Next"**
5. Select **Target type**: **AWS service**
6. Set:
   - **Service**: AWS Lambda
   - **Function**: `email-cleanup-system`
7. Click **"Create rule"**

## Step 9: Test the Function

1. Go back to Lambda console
2. Click **"Test"** tab
3. Create a test event (just use default)
4. Click **"Test"** button
5. Check the execution logs

Expected output:
```
{
  "statusCode": 200,
  "body": "{\"message\": \"Email cleanup completed\", \"stats\": {...}}"
}
```

## Step 10: Monitor with CloudWatch

1. Go to [CloudWatch Console](https://console.aws.amazon.com/cloudwatch)
2. Click **"Log groups"**
3. Find `/aws/lambda/email-cleanup-system`
4. View logs from each execution

## Troubleshooting

### "Unable to import module 'lambda_handler'"
- Ensure `lambda-deployment.zip` includes all Python files
- Verify `lambda_handler.py` is in the root of the ZIP

### "User is not authorized to perform: secretsmanager:GetSecretValue"
- Check IAM role has the correct inline policy
- Verify secret name is `gmail-credentials`

### "Access blocked" error during execution
- Ensure your Gmail address is a test user in Google Cloud Console
- Verify refresh token is valid

### Function times out
- Increase timeout to 90 seconds
- Check Gmail API rate limits

## Cost Estimate

- **Lambda**: Free tier covers ~1M invocations/month
- **Secrets Manager**: ~$0.40/month
- **EventBridge**: Free tier covers 10 rules
- **CloudWatch Logs**: Free tier covers 5GB/month

**Total monthly cost**: ~$0.40

## Next Steps

1. Test with a few executions
2. Monitor CloudWatch logs
3. Adjust schedule if needed (currently 9 AM daily)
4. Consider adding SNS notifications for errors
5. Scale to other inboxes (shared mailboxes, executive accounts)

---

**Questions?** Check the main [README.md](README.md) for more info.
